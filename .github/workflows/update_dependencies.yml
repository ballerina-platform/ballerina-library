name: Update Stdlib Dependency Graph

on:
    workflow_dispatch:
    schedule:
        -   cron: '0 3,15 * * *' # Run everyday at 8.30 AM and 8.30 PM on LK time
    push:
        branches:
          - main
        paths:
          - 'release/resources/module_list.json'

jobs:
    dependency_graph:
        name: Update the Standard Library Dependency Graph
        runs-on: ubuntu-latest
        steps:
            -   name: Install Ballerina
                run: |
                    wget https://dist.ballerina.io/downloads/2201.0.3/ballerina-2201.0.3-swan-lake-linux-x64.deb
                    sudo dpkg -i ./ballerina-2201.0.3-swan-lake-linux-x64.deb

            -   name: Checkout Repo
                uses: actions/checkout@v2
                with:
                    token: ${{ secrets.BALLERINA_BOT_TOKEN }}

            -   name: Configure Git User
                run: |
                    git config --global user.name ${{ secrets.BALLERINA_BOT_USERNAME }}
                    git config --global user.email ${{ secrets.BALLERINA_BOT_EMAIL }}

            -   name: Get Dependencies and update files
                run: |
                    cd dashboard
                    bal run
                    cd ..
                env:
                    BALLERINA_BOT_TOKEN: ${{ secrets.BALLERINA_BOT_TOKEN }}

            -   name: Commit files
                run: |
                    git add -A
                    git diff-index --quiet HEAD || git commit -m "[AUTOMATED] Update the dependency graph and the dashboard"
                    git push
